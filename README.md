# Приложение PhotoGallery

Это приложение Node.js, построенное с использованием Express, которое представляет собой фотогалерею, позволяющую пользователям загружать, хранить и просматривать изображения. Приложение использует MySQL для постоянного хранения данных и поддерживает кросс-доменные запросы (CORS).

## Структура проекта

```
├── app.js                 # Основной файл приложения, настраивает middleware Express
├── db.js                  # Конфигурация подключения к базе данных
├── init.sql              # SQL-скрипт для инициализации таблицы базы данных
├── package.json          # Зависимости проекта и скрипты
├── README.md             # Этот файл
├── bin/
│   └── www               # Точка входа в приложение, запускает HTTP-сервер
├── public/
│   ├── images/           # Директория для хранения загруженных изображений
│   └── stylesheets/
│       └── style.css     # Публичные CSS-стили
└── routes/
    └── index.js          # Обработчики маршрутов для API
└── views/
    ├── error.pug         # Шаблон страницы ошибки
    ├── index.pug         # Шаблон главной страницы
    └── layout.pug        # Базовый шаблон
```

## Зависимости

- **Express**: Веб-фреймворк для создания приложения
- **MySQL**: Драйвер базы данных для подключения к MySQL
- **Pug**: Шаблонизатор для генерации HTML
- **CORS**: Middleware для включения кросс-доменных запросов
- **Express-form-data**: Middleware для обработки multipart/form-data
- **UUID**: Библиотека для генерации уникальных идентификаторов
- **Cookie-parser**: Парсит заголовок Cookie и наполняет req.cookies
- **Morgan**: Логгер HTTP-запросов
- **Debug**: Маленькая утилита для отладки

## Схема базы данных

Приложение использует базу данных MySQL с таблицей под названием `data`, которая определена следующим образом:

```sql
CREATE TABLE IF NOT EXISTS db.`data` (
  id INT NOT NULL AUTO_INCREMENT,
  `path` varchar(255) NOT NULL,
  name varchar(255) NOT NULL,
  author varchar(255) NULL,
  description varchar(2048) NULL,
  `date` TIMESTAMP DEFAULT now() NOT NULL,
  CONSTRAINT data_PK PRIMARY KEY (id)
)
ENGINE=InnoDB
DEFAULT CHARSET=utf8mb4
COLLATE=utf8mb4_general_ci;
```

## API Маршруты

### GET /
- **Описание**: Отображает главную страницу с приветственным сообщением и ссылками на другие разделы
- **Ответ**: HTML-страница с оформлением и навигацией

### GET /upload
- **Описание**: Отображает форму для загрузки новых изображений
- **Ответ**: HTML-страница с удобной формой загрузки изображений с предварительным просмотром и автоматическим заполнением названия на основе имени файла

### GET /gallery
- **Описание**: Отображает галерею изображений в виде веб-страницы с актуальными изображениями
- **Ответ**: HTML-страница с визуальным представлением всех изображений из базы данных в карточках

### GET /all
- **Описание**: Получает все изображения из базы данных в формате JSON (только для API)
- **Ответ**: JSON-массив, содержащий все записи из таблицы `data`
- **Пример ответа**:
  ```
  [
    {
      id: 1,
      path: "a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
      name: "Закат",
      author: "Иван Иванов",
      description: "Красивое изображение заката",
      date: "2023-01-01T10:00:00.000Z"
    }
  ]
  ```

### POST /new
- **Описание**: Загружает новое изображение в галерею
- **Тело запроса**: Данные формы multipart со следующими полями:
  - `image` (обязательно): Файловый объект, содержащий изображение
  - `name` (обязательно, если не указано, используется имя файла): Название/заголовок изображения (с экранированием для предотвращения SQL-инъекций)
  - `description` (опционально): Описание изображения
  - `author` (опционально): Автор изображения
- **Ответ**: При успешной загрузке возвращает сгенерированное имя файла загруженного изображения
- **Коды состояния**:
  - 200: Успешно
  - 400: Неверный запрос (отсутствует файл изображения)
  - 500: Внутренняя ошибка сервера

### DELETE /image/:id
- **Описание**: Удаляет изображение из галереи по ID
- **Параметры**: `id` - идентификатор изображения в базе данных
- **Ответ**: Сообщение об успешном удалении изображения
- **Коды состояния**:
  - 200: Успешно удалено
  - 404: Изображение не найдено
  - 500: Внутренняя ошибка сервера

### GET /analytics
- **Описание**: Главная страница аналитики с объединенными метриками (доступна только с локального IP)
- **Ответ**: HTML-страница с визуализацией общей статистики, временных паттернов и топ-10 авторов
- **Коды состояния**:
  - 200: Успешно
  - 403: Доступ запрещен (если не с локального IP)

### GET /analytics/raw/count
- **Описание**: Сырые данные - количество сущностей в базе данных (доступно только через API)
- **Ответ**: JSON с общей статистикой (всего изображений, уникальных авторов и т.д.)
- **Коды состояния**:
  - 200: Успешно
  - 403: Доступ запрещен
  - 500: Ошибка базы данных

### GET /analytics/raw/timeline
- **Описание**: Сырые данные - статистика по датам загрузки (доступно только через API)
- **Ответ**: JSON с количеством загрузок по дням в человеко-читаемом формате
- **Коды состояния**:
  - 200: Успешно
  - 403: Доступ запрещен
  - 500: Ошибка базы данных

### GET /analytics/raw/authors
- **Описание**: Сырые данные - статистика по авторам (доступно только через API)
- **Ответ**: JSON с топ-20 авторов по количеству загрузок
- **Коды состояния**:
  - 200: Успешно
  - 403: Доступ запрещен
  - 500: Ошибка базы данных

### POST /image/:id/view
- **Описание**: Увеличивает счётчик просмотров для изображения
- **Параметры**: `id` - идентификатор изображения в базе данных
- **Ответ**: Сообщение об успешном обновлении счётчика
- **Коды состояния**:
  - 200: Успешно
  - 404: Изображение не найдено
  - 500: Внутренняя ошибка сервера

## Функции пользовательского интерфейса
- **Просмотр в полноэкранном режиме**: Возможность просмотра изображений в увеличенном виде по клике на миниатюру с отображением информации о них
- **Скачивание изображений**: Возможность скачивания изображений с сохранением оригинального имени файла и расширения
- **Удаление изображений**: Безопасное удаление изображений из галереи с подтверждением
- **Аналитика**: Доступ к аналитике (только с локального IP) с объединённой визуализацией статистики
- **Счетчик просмотров**: Отображение и автоматическое увеличение счётчика просмотров при открытии изображения

## Безопасность
- Используются подготовленные выражения (prepared statements) для предотвращения SQL-инъекций
- Валидация и ограничения файлов не реализованы в текущей версии - рекомендуется добавить проверки типов файлов и ограничения по размеру в продакшен-версии
- Доступ к аналитическим эндпоинтам ограничен - они доступны только с локального IP (127.0.0.1, ::1, localhost)

## Интерфейс
- Современный и интуитивно понятный интерфейс с навигационным меню
- Адаптивный дизайн, корректно отображающийся на мобильных устройствах
- Визуальные эффекты и анимации для улучшения пользовательского опыта
- Раздел данных (/all) доступен только через API (не отображается в пользовательском интерфейсе)
- Возможность просмотра изображений в полноэкранном режиме (по клику на миниатюру)
- Возможность скачивания изображений (с сохранением оригинального расширения файла)
- Управление изображениями (удаление с подтверждением)

## Конфигурация

Приложение подключается к базе данных MySQL со следующей конфигурацией по умолчанию (определенной в db.js):
- Хост: localhost
- Пользователь: mysql
- Пароль: mysql
- База данных: db

Сервер слушает порт 3000 по умолчанию, хотя это можно изменить с помощью переменной окружения PORT.

## Структура базы данных

Таблица `data` содержит следующие поля:
- `id`: Идентификатор изображения (INT, AUTO_INCREMENT, PRIMARY KEY)
- `path`: Путь к файлу изображения (varchar(255), NOT NULL)
- `name`: Название изображения (varchar(255), NOT NULL)
- `author`: Автор изображения (varchar(255), NULL)
- `description`: Описание изображения (varchar(2048), NULL)
- `date`: Дата загрузки (TIMESTAMP, NOT NULL, DEFAULT now())
- `views`: Количество просмотров (INT, NOT NULL, DEFAULT 0)

## Запуск приложения

1. Установите зависимости: `npm install`
2. Убедитесь, что MySQL работает и база данных инициализирована с помощью init.sql
3. Запустите приложение: `npm start`
4. Откройте приложение по адресу http://localhost:3000